{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Progress...</title>
    <link rel="stylesheet" href="{% static 'progress.css' %}">
</head>
<body>
    <div class="heading">
        <div class="title">UNMASQUE</div>
        <div class="subtitle"><span class="bi">U</span>nified <span class="bi">N</span>on-invasive <span class="bi">MA</span>chine for <span class="bi">S</span>ql <span class="bi">QU</span>ery <span class="bi">E</span>xtraction</div>
    </div>
    <div class="content_o">
        <div class="hidQ subtext">
            <h1>Hidden Query</h1>
            <textarea readonly class="roArea" id="query" rows="5" cols="100">{{ query }}</textarea>
        </div>
        <div class="progress subtext">
            <h1>Please Wait...</h1>
            <div id='progress-updates'>{{ progress_message }}</div>
        </div>
        <div class="pipeline"> 
            <div class="first row">
                <div id="from_and_union">
                    <div class="stage_and_transitions">
                        <div class="stage out" id="from">
                            <svg width="180" height="100" viewBox="0 0 542 233" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path data-state="FROM CLAUSE" class="path inactive" d="M342 2H2V231H342L539 119L342 2Z" stroke="black" stroke-width="5"/>
                            </svg>
                            <div>FROM</div>
                        </div>
                        <div class="transition" id="from_from">
                            <svg width="300" height="60" viewBox="0 0 460 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="main_p not_taken" d="M364 17.5H2V37H364V50L459 26.5L364 2V17.5Z" stroke="black" stroke-width="3"/>
                            </svg>    
                        </div>
                    </div>
                    <div class="stage_and_transitions">
                        <div class="stage out" id="union_from">
                            <svg width="180" height="100" viewBox="0 0 542 233" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path data-state="UNION" class="path inactive" d="M342 2H2V231H342L539 119L342 2Z" stroke="black" stroke-width="5"/>
                            </svg>
                            <div>UNION FROM</div>
                        </div>
                        <div class="transition" id="from_union_from">
                            <svg width="300" height="60" viewBox="0 0 460 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="union_p not_taken" d="M364 17.5H2V37H364V50L459 26.5L364 2V17.5Z" stroke="black" stroke-width="3"/>
                            </svg>    
                        </div>
                    </div>
                </div>
                <div class="substages">
                    <div class="stage in_out" id="restore_db">
                        <svg width="300" height="120" viewBox="0 0 240 82" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="RESTORE DATABASE" class="path inactive"  d="M198.5 2H4L40.5 40.5L4 80.5H198.5L237 40.5L198.5 2Z" stroke="black" stroke-width="3"/>
                        </svg>
                            
                        <div>RESTORE DB</div>
                    </div>
                    <div class="stage in_out" id="sampling">
                        <svg width="300" height="120" viewBox="0 0 240 82" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="SAMPLING" class="path inactive"  d="M198.5 2H4L40.5 40.5L4 80.5H198.5L237 40.5L198.5 2Z" stroke="black" stroke-width="3"/>
                        </svg>
                            
                        <div>SAMPLING</div>
                    </div>
                    <div class="stage in_out" id="min_db">
                        <svg width="300" height="120" viewBox="0 0 240 82" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="DB MINIMIZATION" class="path inactive"  d="M198.5 2H4L40.5 40.5L4 80.5H198.5L237 40.5L198.5 2Z" stroke="black" stroke-width="3"/>
                        </svg>
                            
                        <div>MINIMIZE DB</div>
                    </div>
                </div>
                <div class="container">
                    <div class="transition" id="min_db_t">
                        <svg width="170" height="170" viewBox="0 0 166 138" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path class="main_p not_taken" d="M164 2H131.5C131.5 2 133.128 50.7121 131.5 62.5C129.872 74.2879 128.519 80.8577 112 82.5C95.4807 84.1423 36 85 36 85L35.5 68.5L3 101.5L35.5 133.5V117.5H66H103C112.177 116.133 113.962 117.722 126.5 114C139.038 110.278 145.494 101.273 147.5 101.5C152.472 96.508 160.5 82.5 160.5 82.5C160.5 82.5 164.115 70.4147 164 62.5V2Z" stroke="black" stroke-width="3"/>
                        </svg>
                    </div>
                </div>
                
            </div>
            <div class="second row">
                <div>
                    <div class="stage " id="start">
                        <div id="start_txt">START</div>
                        <svg width="200" height="80" viewBox="0 0 217 89" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="START" d="M0.5 88.5V0.5H216.5V88.5H0.5Z" stroke="black" stroke-width="3" fill="#89fdfd"/>
                        </svg>
                    </div>
                    
                    <div class="container">
                        <div class="transition" id="start_from">
                            <svg width="96" height="94" viewBox="0 0 96 94" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="main_p" d="M1 52V93.5H24V54.5C25.8622 44.3211 28.5715 40.3412 38 38H70V49L94.5 26L70 2V14.5H38C13.9681 19.5558 7.16147 29.061 1 52Z" stroke="black" stroke-width="3"/>
                            </svg>                   
                        </div>
                    </div>
                    <div class="container">
                        <div class="transition" id="start_union">
                            <svg width="96" height="94" viewBox="0 0 96 94" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="union_p" d="M1 52V93.5H24V54.5C25.8622 44.3211 28.5715 40.3412 38 38H70V49L94.5 26L70 2V14.5H38C13.9681 19.5558 7.16147 29.061 1 52Z" stroke="black" stroke-width="3"/>
                            </svg>                   
                        </div>
                    </div>
                </div>
                
                <div class="substages">
                    <div class="stage in_out" id="projection">
                        <svg width="300" height="120" viewBox="0 0 272 87" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="PROJECTION" class="path inactive" d="M42.5 2L3 43L42.5 85.5H268L227 43L268 2H42.5Z" stroke="black" stroke-width="3"/>
                        </svg>    
                        <div>PROJECTION</div>
                    </div>
                    <div class="stage in_out" id="inequality">
                        <svg width="300" height="120" viewBox="0 0 272 87" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="INEQUALITY PREDICATES" class="path inactive" d="M42.5 2L3 43L42.5 85.5H268L227 43L268 2H42.5Z" stroke="black" stroke-width="3"/>
                        </svg>    
                        <div>INEQUALITY</div>
                        <div class="container">
                            <div class="transition" id="rdb_t">
                                <svg width="67" height="97" viewBox="0 0 67 97" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path class="dis_p" d="M2 31.5H19V96H50.5V31.5H65.5L34.5 1L2 31.5Z" stroke="black" stroke-width="3"/>
                                </svg>
                                                                    
                            </div>
                        </div>
                    </div>
                    <div class="stage in_out" id="equality">
                        <svg width="300" height="120" viewBox="0 0 272 87" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="EQUALITY PREDICATES" class="path inactive" d="M42.5 2L3 43L42.5 85.5H268L227 43L268 2H42.5Z" stroke="black" stroke-width="3"/>
                        </svg>
                            
                        <div>EQUALITY</div>
                    </div>
                    <div class="stage in_out" id="filter">
                        <svg width="300" height="120" viewBox="0 0 272 87" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="FILTER" class="path inactive" d="M42.5 2L3 43L42.5 85.5H268L227 43L268 2H42.5Z" stroke="black" stroke-width="3"/>
                        </svg>        
                        <div>FILTER</div>
                    </div>
                    <div class="container">
                        <div class="transition" id="filter_t">
                            <svg width="196" height="79" viewBox="0 0 196 79" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="nep_p" d="M20 1H1V38C4.4593 57.706 11.8634 63.6956 32.5 67.5H175V77L194.5 57.5L175 38V47.5H32.5C25.2826 46.2335 22.1605 44.1722 20 35.5V1Z" stroke="black" stroke-width="3"/>
                            </svg>                                   
                        </div>
                    </div>
                </div>
                <div class="right stages">
                    <div class="stage in_out" id="nep">
                        <svg width="120" height="250" viewBox="0 0 90 218" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="NEP_COMPARATOR" class="path inactive" d="M89 1H1V217H89V1Z" stroke="black"/>
                        </svg>       
                        <div>NEP RESULT COMPARATOR</div>
                    </div>
                    <div class="container">
                        <div class="transition" id="nep_res">
                            <svg width="67" height="97" viewBox="0 0 67 97" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="nep_p" d="M2 31.5H19V96H50.5V31.5H65.5L34.5 1L2 31.5Z" stroke="black" stroke-width="3"/>
                            </svg>
                                                                
                        </div>
                    </div>
                    <div class="stage in_out" id="trap">
                        <svg width="200" height="80" viewBox="0 0 217 89" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="trap" id="trapP" class="path inactive" d="M0.5 88.5V0.5H216.5V88.5H0.5Z" stroke="black" stroke-width="3"/>
                        </svg>
                                
                        <div>TRAP</div> 
                    </div>
                    <div class="container">
                        <div class="transition" id="nep_t">
                            <svg width="95" height="121" viewBox="0 0 95 121" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="nep_p" d="M24.4126 2L1 25.4696L24.4126 50.895V38.5083H56.9301C65.8973 40.8434 68.9136 44.0167 70.5874 52.8508V120H94V50.895L92.6993 44.3757C88.3337 27.0455 81.0272 20.9774 61.4825 15.0387L54.979 13.7348H24.4126V2Z" stroke="black" stroke-width="3"/>
                            </svg>      
                        </div>
                    </div>
                    <div class="container">
                        <div class="transition" id="nep_t2">
                            <svg width="87" height="51" viewBox="0 0 87 51" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="oj_p" d="M59 0.5H0.5V13.5H59C63.0049 15.5265 64.7093 16.9965 65.5 21V38H59L72 50L85.5 38H77.5V19.5C75.8322 8.92521 71.7368 4.78371 59 0.5Z" stroke="black" stroke-width="3"/>
                                </svg>                                 
                        </div>
                    </div>
                    <div class="stage in_out" id="oj">
                        <svg width="120" height="250" viewBox="0 0 90 218" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="OUTER JOIN" class="path inactive" d="M89 1H1V217H89V1Z" stroke="black"/>
                        </svg>       
                        <div>OUTER JOIN</div>
                    </div>
                    <div class="container">
                        <div class="transition" id="oj_t">
                            <svg width="92" height="159" viewBox="0 0 92 159" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="main_p" d="M68 104.5V1H91V107C85.4386 132.909 76.6292 140.222 54 144.5H23V157L1 134L23 111.5V123H54C64.1914 119.217 66.5856 114.677 68 104.5Z" stroke="black" stroke-width="3"/>
                            </svg>                        
                        </div>
                    </div>
                </div>
            </div>
            <div class="third row">
                <div class="substages">
                    <div class="stage in_out" id="group_by">
                        <div class="container">
                            <div class="transition" id="projection_t">
                                <svg width="67" height="97" viewBox="0 0 67 97" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path class="main_p" d="M2 31.5H19V96H50.5V31.5H65.5L34.5 1L2 31.5Z" stroke="black" stroke-width="3"/>
                                </svg>                              
                            </div>
                        </div>
                        <svg width="300" height="120" viewBox="0 0 240 82" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="GROUP BY" class="path inactive"  d="M198.5 2H4L40.5 40.5L4 80.5H198.5L237 40.5L198.5 2Z" stroke="black" stroke-width="3"/>
                        </svg>
                            
                        <div>GROUP BY</div>
                    </div>
                    
                    <div class="stage in_out" id="agg">
                        <svg width="300" height="120" viewBox="0 0 240 82" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="AGGREGATE" class="path inactive"  d="M198.5 2H4L40.5 40.5L4 80.5H198.5L237 40.5L198.5 2Z" stroke="black" stroke-width="3"/>
                        </svg>
                            
                        <div>AGGREGATE</div>
                    </div>
                    <div class="stage in_out" id="ob">
                        <svg width="300" height="120" viewBox="0 0 240 82" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="ORDER BY" class="path inactive"  d="M198.5 2H4L40.5 40.5L4 80.5H198.5L237 40.5L198.5 2Z" stroke="black" stroke-width="3"/>
                        </svg>
                            
                        <div>ORDER BY</div>
                    </div>
                    <div class="stage in_out" id="limit">
                        <svg width="300" height="120" viewBox="0 0 240 82" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="LIMIT" class="path inactive"  d="M198.5 2H4L40.5 40.5L4 80.5H198.5L237 40.5L198.5 2Z" stroke="black" stroke-width="3"/>
                        </svg>
                            
                        <div>LIMIT</div>
                    </div>
                </div>
                <div class="container">
                    <div class="stage in_out" id="res_comp">
                        <svg width="300" height="120" viewBox="0 0 217 89" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="RESULT COMPARATOR" class="path inactive" d="M0.5 88.5V0.5H216.5V88.5H0.5Z" stroke="black" stroke-width="3"/>
                        </svg>
                                
                        <div>RESULT COMPARATOR</div> 
                    </div>
                </div>

                <div class="container">
                    <div class="transition" id="limit_t">
                        <svg width="120" height="150" viewBox="0 0 112 132" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path class="main_p" d="M28.5 0.5H0.5V70.5C6.51008 102.415 18.4948 110.59 48 116H82.5V130.5L111 103L82.5 74V88.5H48C34.6149 85.303 30.4574 80.6079 28.5 67.5V0.5Z" stroke="black" stroke-width="3"/>
                        </svg>                        
                    </div>
                </div>
                <div class="container">
                    <div class="transition" id="limit_nep">
                        <svg width="250" height="60" viewBox="0 0 460 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path class="nep_p not_taken" d="M364 17.5H2V37H364V50L459 26.5L364 2V17.5Z" stroke="black" stroke-width="3"/>
                        </svg>    
                    </div>
                </div>
                <div class="container">
                    <div class="transition" id="limit_oj">
                        <svg width="400" height="60" viewBox="0 0 460 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path class="oj_p not_taken" d="M364 17.5H2V37H364V50L459 26.5L364 2V17.5Z" stroke="black" stroke-width="3"/>
                        </svg>    
                    </div>
                </div>
                <div class="container">
                    <div class="stage in_out" id="finished">
                        <svg width="200" height="120" viewBox="0 0 217 89" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path data-state="_DONE" class="path inactive" d="M0.5 88.5V0.5H216.5V88.5H0.5Z" stroke="black" stroke-width="3"/>
                        </svg>
                                
                        <div>FINISHED</div> 
                    </div>
                </div>
                <div class="container">
                    <div class="transition" id="res_finish">
                        <svg width="250" height="60" viewBox="0 0 460 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path class="main_p not_taken" d="M364 17.5H2V37H364V50L459 26.5L364 2V17.5Z" stroke="black" stroke-width="3"/>
                        </svg>    
                    </div>
                </div>
                
            </div>
        </div>
        <div class="stage_res">
            <div class="subtitle">Select a pipeline stage</div>
            <div class="subcontent" style="display: none;">
                <div class="input">
                    <div class="subtext">Input</div>
                    <div class="subsubcontent"></div>
                </div>
                <div class="output">
                    <div class="subtext">Output</div>
                    <div class="subsubcontent"></div>
                </div>
            </div>
        </div>
        <div class="res">
            <h1>Output</h1>
            <div class="outContainer">
                <div class="innerContainer1">
                    <div class="inincont">
                        <label class="state_label">SELECT</label>
                        <textarea readonly class="roArea state_sql" id="select_text" rows="3" cols="50"></textarea>
                    </div>
                    <div class="inincont">
                        <label class="state_label">FROM</label>
                        <textarea readonly class="roArea state_sql" id="from_text" rows="3" cols="50"></textarea>
                    </div>
                </div>
                <div class="innerContainer1">
                    <div class="inincont">
                        <label class="state_label">WHERE</label>
                        <textarea readonly class="roArea state_sql" id="where_text" rows="3" cols="50"></textarea>
                    </div>
                    <div class="inincont">
                        <label class="state_label">GROUP BY</label>
                        <textarea readonly class="roArea state_sql" id="group_by_text" rows="3" cols="50"></textarea>
                    </div>
                </div>
                <div class="innerContainer1">
                    <div class="inincont">
                        <label class="state_label">ORDER BY</label>
                        <textarea readonly class="roArea state_sql" id="order_by_text" rows="3" cols="50"></textarea>
                    </div>
                    <div class="inincont">
                        <label class="state_label">LIMIT</label>
                        <textarea readonly class="roArea state_sql" id="limit_text" rows="3" cols="50"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="stateinfo">
            <h1>Output from modules</h1>
            <div class="actualInfo">

            </div>
        </div>
        <div class="btnContainer">
            <a href="{% url 'cancel' token %}" ><button class="cancel_submit">Cancel</button></a>
            <a href="{% url 'result' token %}" ><button class="submit" id="res_btn" disabled>Result</button></a>
        </div>
    </div>
    <!-- Progress updates will be displayed here -->

    <!-- Include jQuery library (you can use a different library if you prefer) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        var data;
        let WAITING = "_WAITING"
        let DONE = "_DONE"
        let START = "_START"
        let ERROR = "_ERROR"
        let WRONG = "_WRONG"
        let RUNNING = "_RUNNING"
        let FROM_CLAUSE = "FROM CLAUSE"
        let EQUALITY = "EQUALITY PREDICATES"
        let FILTER = "FILTER"
        let INEQUALITY = "INEQUALITY PREDICATES"
        let PROJECTION = "PROJECTION"
        let GROUP_BY = "GROUP BY"
        let AGGREGATE = "AGGREGATE"
        let ORDER_BY = "ORDER BY"
        let LIMIT = "LIMIT"
        let UNION = "UNION"
        let SAMPLING = "SAMPLING"
        let DB_MINIMIZATION = "DB MINIMIZATION"
        let RESULT_COMPARE = "RESULT COMPARATOR"
        let RESTORE_DB = "RESTORE DATABASE"
        let OUTER_JOIN = "OUTER JOIN"
        let NEP_COMPARATOR = "NEP_COMPARATOR"
        let handle_circle_click = (ev) => {
            const clicked = ev.target;
            console.log(clicked)
            if(!$(".subcontent").is(":visible")){
                $(".subcontent").show();
            }
            $(".stage_res").get(0).scrollIntoView({behavior: 'smooth'});
            switch(clicked.dataset.state){
                case STATES[2]:
                    $(".input > .subsubcontent").html(data.io[STATES[2]].input)
                    $(".output > .subsubcontent").html(data.io[STATES[2]].output)
                    break
                
                default:
                    $(".input > .subsubcontent").html("No info found for the selected stage")
                    $(".output > .subsubcontent").html("No info found for the selected stage")
                    break
            }
        }

        let circle_event_adder = () => {
            let circles = document.getElementsByClassName("path");
            for(let circle of circles){
                circle.addEventListener("click", handle_circle_click);
            }
        }
        let where_and_join = (fil, ej) =>{
            let joins = []
            where_op = ""
            if(ej){
                for (let edge of ej){
                    edge.sort()
                    for(let i=0; i < edge.length - 1; i++){
                        left_e = edge[i]
                        right_e = edge[i + 1]
                        join_e = `${left_e} = ${right_e}`
                        joins.push(join_e)
                    }    
                }
            }
            where_op = joins.join(" and ")
            if(where_op != "" && fil && fil[1] != ""){
                where_op += " and "
            }
            where_op += (fil)?fil[1]:""
            return where_op
        }

        let g = () => {
            (onOrOff[STATES.indexOf(i)] == 1)
            var coll = document.getElementsByClassName("collapsible");
            var i;
            for (i = 0; i < coll.length; i++) {
                if((onOrOff[1+i] == 1)){
                    coll[i].classList.toggle("active")
                    content = coll[i].nextElementSibling
                    if (content.style.display === "block") {
                        content.style.display = "none";
                    } else {
                        content.style.display = "block";
                    }
                }
            }
        }

        let f = () =>{
            var coll = document.getElementsByClassName("collapsible");
            var i; 

            for (i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                console.log(this.innerHTML)
                onOrOff[STATES.indexOf(this.innerHTML)] = 1- onOrOff[STATES.indexOf(this.innerHTML)]
                console.log(onOrOff)
                var content = this.nextElementSibling;
                if (content.style.display === "flex") {
                    content.style.display = "none";
                } else {
                    content.style.display = "flex";
                }
            });
            }
        }
        let k = (prev, data) =>{
            if(STATES.indexOf(data.progress_message) == -1) return;
            for(let i of STATES.slice(1, STATES.indexOf(data.progress_message))){
                switch(i){
                    case FROM_CLAUSE:
                        $("#from_text").empty()
                        for(let f=0; f<data.state_info[STATES[2]].length; f++){
                            if(f == data.state_info[STATES[2]].length-1) $("#from_text").append(data.state_info[STATES[2]][f])
                            else $("#from_text").append(data.state_info[STATES[2]][f] + ", ")
                        }
                        break
                    
                    case FILTER:
                        $("#where_text").empty()
                        $("#where_text").append(data.state_info[STATES[6]])
                        break
                    
                    case PROJECTION:
                        var p_name = data.state_info[PROJECTION]['names']
                        var p_attrib = data.state_info[PROJECTION]['attribs']
                        res = ""
                        for(let i = 0; i<p_name.length; i++){
                            if(p_name[i] == p_attrib[i]){
                                res += (p_name[i])
                            }
                            else{
                                res += (p_attrib[i]+" as " + p_name[i]);
                            }
                            if(i!=p_name.length-1) res += ", ";
                        }
                        $("#select_text").empty()
                        $("#select_text").append(res)
                        break
                    
                    case GROUP_BY:
                        $("#group_by_text").empty();
                        res = ""
                    
                        let g_attribs = data.state_info[GROUP_BY]
                        if(!g_attribs) continue
                        for(let i=0; i<g_attribs.length; i++){
                            if(i!=g_attribs.length-1) res += (g_attribs[i] + ", ")
                            else res += g_attribs[i]
                        }
                        $("#group_by_text").append(res)
                        break
                    
                    case AGGREGATE:
                        
                        let aggs = data.state_info[AGGREGATE]
                        if(!aggs) continue;
                        res = ""
                        $("#select_text").empty()
                        for(let i=0; aggs != null &&  i<aggs.length; i++){
                            if(aggs[i][1] == "") res += aggs[i][0];
                            else{
                                res += aggs[i][1] + "(" + aggs[i][0] + ")"
                            }
                            if(p_name[i] != p_attrib[i]) res += " as " + p_name[i]
                            if(i != aggs.length-1) res += ", "
                        }
                        $("#select_text").append(res)
                        break;
                    
                    case ORDER_BY:
                        $("#order_by_text").empty()
                        
                        if(data.state_info[ORDER_BY]) $("#order_by_text").append(data.state_info[ORDER_BY].slice(0, data.state_info[ORDER_BY].length-2))
                        break;

                    case LIMIT:
                        $("#limit_text").empty();
                        if(data.state_info[LIMIT]) $("#limit_text").append(data.state_info[STATES[12]]);
                        break;
                }
            }
        }
        


        let STATES = {{states | safe}}
        let done = []
        var onOrOff = new Array(STATES.length)
        var SELECT = []
        var FROM = []
        var WHERE = []
        var GROUP_BY_text = []
        var ORDER_BY_text = []
        var LIMIT_text = null 
        onOrOff.fill(0)
        STATES.push("DUMMY")
        circle_event_adder()
        console.log(STATES)
        var curr_state = STATES[0]
        // Function to fetch progress updates using AJAX
        let stateInfoRefine = (data, curr_state) =>{
            if(curr_state == WAITING) return ""
            if(curr_state == INEQUALITY && data.state_info[curr_state] != null) return JSON.stringify(data.state_info[curr_state][0])
            if(curr_state == SAMPLING){
                if(data.state_info[SAMPLING] == SAMPLING + "DISABLED") 
                {
                    return "SAMPLING DISABLED!";
                }
                else if(data.state_info[SAMPLING] == SAMPLING + "FAILED"){
                    return "SAMPLING FAILED!";
                }
                else{
                    res = "<table class=\"min_tab sample_table\"><tr><th>Table</th><th>Sample</th><th>Original</th></tr>"
                    for(let ele of data.state_info[FROM_CLAUSE]){
                        res += "<tr>"+("<td>"+ele+"</td><td>"+data.state_info[SAMPLING]["sample"][ele] + "</td><td>" + data.state_info[SAMPLING]["size"][ele] + "</td></tr>")
                    }
                    res += "</table>"
                    return res;
                }
            }            
            return JSON.stringify(data.state_info[curr_state])
        }

        let getTables = (data) => {
            tables = data.state_info[FROM_CLAUSE]
            dbmin = data.state_info[DB_MINIMIZATION]
            res = ""
            for(let i=0; i<tables.length; i++){
                res += "<div class=\"tab_title\">" + tables[i] +"<div>" 
                res+="<table class=\"min_tab\"><tr>"
                for(let j=0; j<dbmin[tables[i]][0].length; j++){
                    res += "<th>"+ dbmin[tables[i]][0][j] +"</th>"
                }
                res += "</tr><tr>"
                for(let j=0; j<dbmin[tables[i]][1].length; j++){
                    res += "<td>"+ dbmin[tables[i]][1][j] +"</td>"
                }
                res+="</tr></table>"
            }
            return res
        }

        function fetchProgress() {
            $.ajax({
                url: "{% url 'check_progress' token %}", // Update with your view's URL
                type: "GET",
                dataType: "json", // Change data type if necessary
                success: function(dat) {
                    // Update the progress-updates div with the received data
                    data = dat
                    console.log(data.progress_message, curr_state)
                    console.log(data.curr_states)
                    console.log(data.done_states)
                    $("#progress-updates").html(data.progress_message);
                    if(data.curr_states[data.curr_states.length-1] == WRONG || data.curr_states[data.curr_states.length-1] == ERROR){
                        console.log("WRONG")
                        //setTimeout(() => window.location.href = "/unmasque/result/{{ token }}",5000)
                        return
                    }
                    else{
                        data.progress_message = data.progress_message.replace("_START", "")
                        data.progress_message = data.progress_message.replace("_RUNNING", "")
                        if(data.progress_message != "_DONE") data.progress_message = data.progress_message.replace("_DONE", "")
                        for(let i=0; i<data.done_states.length; i++){
                            data.done_states[i] = data.done_states[i].replace("_START", "")
                            data.done_states[i] = data.done_states[i].replace("_RUNNING", "")
                            if(data.done_states[i] != "_DONE") data.done_states[i] = data.done_states[i].replace("_DONE", "")
                        }
                        for(let i=0; i<data.curr_states.length; i++){
                            data.curr_states[i] = data.curr_states[i].replace("_START", "")
                            data.curr_states[i] = data.curr_states[i].replace("_RUNNING", "")
                            if(data.curr_states[i] != "_DONE") data.curr_states[i] = data.curr_states[i].replace("_DONE", "")
                        }
                        if(curr_state != data.curr_states[data.curr_states.length-1]){
                            let circles = document.getElementsByClassName("path");
                            if(circles){
                                for(let circle of circles){
                                    if(data.done_states.find((x)=>x==circle.dataset.state)){
                                        circle.classList.remove("inactive")
                                        circle.classList.remove("running")
                                        circle.classList.add("done");
                                    }
                                    if(circle.dataset.state == data.curr_states[data.curr_states.length-1]){
                                        circle.classList.remove("inactive")
                                        circle.classList.remove("done")
                                        circle.classList.add("running");
                                    }
                                }
                            }
                            $(".actualInfo").empty()
                            for(let i of STATES.slice(1, STATES.indexOf(curr_state)+1)){
                                if(i == DB_MINIMIZATION){
                                    $(".actualInfo").append("<div class=\"innerContainer\"><button class=\"collapsible\">"+ i +"</button><div class=\"content dbmin\">" + getTables(data)+ "</textarea></div>")
                                }
                                else if(i == SAMPLING) $(".actualInfo").append("<div class=\"innerContainer\"><button class=\"collapsible\">"+ i +"</button><div class=\"content\">"+stateInfoRefine(data, i)+"</div>")   
                            }
                            //f()
                            //g()
                            k(curr_state, data)
                        }
                        curr_state = data.curr_states[data.curr_states.length-1]
                        //curr_state = data.progress_message
                    }
                    if(curr_state == "_DONE"){
                        if(data.curr_states.find((x)=>x==WRONG||x==ERROR)){
                            console.log("Error occurred or the Answer is wrong")
                            $("#trapP").removeClass("running").removeClass("inactive").addClass("done")
                        }
                        $("#res_btn").removeAttr("disabled")
                        $("#finished > svg > path").removeClass("running").addClass("done")
                        return
                    }
                    // Set a timeout to fetch progress again after 1 second
                    setTimeout(fetchProgress, 1000);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                // Print the error details to the console
                    console.error("AJAX Error:", textStatus, errorThrown);

                // Set a timeout to retry the request after 1 second
                    setTimeout(fetchProgress, 1000);
                }
            });
        }

        // Start fetching progress updates
        $(document).ready(function() {
            fetchProgress();
        });
    </script>
</body>
</html>